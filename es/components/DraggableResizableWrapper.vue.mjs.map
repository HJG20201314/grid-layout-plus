{"version":3,"file":"DraggableResizableWrapper.vue.mjs","sources":["../../src/components/DraggableResizableWrapper.vue"],"sourcesContent":["<template>\r\n  <div ref=\"elementRef\" class=\"draggable-resizable-wrapper\">\r\n    <slot v-bind=\"slotScope\"></slot>\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport {\r\n  type ComputedRef,\r\n  computed, \r\n  onMounted, \r\n  onUnmounted, \r\n  ref, \r\n  watch, \r\n} from 'vue'\r\n\r\nimport { throttle } from '@vexip-ui/utils'\r\n\r\nimport {\r\n  type DraggableResizableWrapperEmits,\r\n  type DraggableResizableWrapperExposed,\r\n  type DraggableResizableWrapperProps,\r\n  type DraggableResizableWrapperSlotScope,\r\n} from './types'\r\n\r\n\r\nimport {\r\n  type DragEventCallbackData,\r\n  type DraggableResizableResult,\r\n  type ElementDragResizeCallbacks,\r\n  type ElementDragResizeOptions,\r\n  type ElementEdges,\r\n  type ResizeEventCallbackData,\r\n  makeElementDraggableResizable,\r\n} from '../utils/interact-helper'\r\nimport { parseCssSize, parsePositionValue } from '../utils/css-units'\r\n\r\n/** 定义组件的 props */\r\nconst props = withDefaults(defineProps<DraggableResizableWrapperProps>(), {\r\n  draggable: true,\r\n  resizable: true,\r\n  useCssTransforms: true,\r\n  dragOptions: () => ({}),\r\n  resizeOptions: () => ({}),\r\n  initialX: 0,\r\n  initialY: 0,\r\n  initialWidth: 200,\r\n  initialHeight: 150,\r\n  watchDeep: false,\r\n  watchImmediate: false,\r\n})\r\n\r\n/** 定义组件的事件 */\r\nconst emit = defineEmits<DraggableResizableWrapperEmits>()\r\n\r\n/** 定义响应式数据 */\r\nconst elementRef = ref<HTMLElement>()\r\n\r\n/** 恢复丢失的响应式状态定义 (位置/尺寸 + 交互状态) */\r\n// 位置和尺寸保持响应式\r\nconst x = ref<number>(typeof props.initialX === 'number' ? props.initialX : 0)\r\nconst y = ref<number>(typeof props.initialY === 'number' ? props.initialY : 0)\r\nconst width = ref<number>(typeof props.initialWidth === 'number' ? props.initialWidth : 200)\r\nconst height = ref<number>(typeof props.initialHeight === 'number' ? props.initialHeight : 150)\r\n\r\n// 定义组件内部状态 - 全部使用响应式变量确保外部可以实时访问\r\nconst isDragging = ref<boolean>(false)\r\nconst isResizing = ref<boolean>(false)\r\nconst activeEdges = ref<Partial<ElementEdges>>({})\r\n\r\n/** 清理函数引用 */\r\nlet cleanupFunction: (() => void) | null = null\r\n\r\n/** 更新位置尺寸方法引用 */\r\nlet updatePositionAndSizeFunction: DraggableResizableResult['updatePositionAndSize'] | null = null\r\nlet updatePositionFunction: DraggableResizableResult['updatePosition'] | null = null\r\nlet updateSizeFunction: DraggableResizableResult['updateSize'] | null = null\r\n\r\n/** watch监听器停止函数引用 */\r\nconst stopWatchListener: (() => void)[] = []\r\n\r\n/** 创建slot作用域数据 */\r\nconst slotScope: ComputedRef<DraggableResizableWrapperSlotScope> = computed(() => ({\r\n  x: x.value,\r\n  y: y.value,\r\n  width: width.value,\r\n  height: height.value,\r\n  isDragging: isDragging.value,\r\n  isResizing: isResizing.value,\r\n  activeEdges: activeEdges.value as Record<string, boolean>,\r\n}))\r\n\r\n/** 创建拖拽和调整大小的回调函数 */\r\nconst createCallbacks = (): ElementDragResizeCallbacks => ({\r\n  onDrag: (data: DragEventCallbackData) => {\r\n    // 性能优化：对于dragmove事件，使用requestAnimationFrame减少响应式更新频率\r\n    if (data.type === 'dragmove') {\r\n      requestAnimationFrame(() => {\r\n        // 更新内部状态\r\n        x.value = data.left\r\n        y.value = data.top\r\n        \r\n        // 发出事件\r\n        emit('dragMove', data)\r\n      })\r\n    } else {\r\n      // 对于dragstart和dragend，立即更新\r\n      if (data.type === 'dragstart') {\r\n        isDragging.value = true\r\n        emit('dragStart', data)\r\n      } else if (data.type === 'dragend') {\r\n        isDragging.value = false\r\n        emit('dragEnd', data)\r\n      }\r\n      // 无论哪种类型，都更新位置\r\n      x.value = data.left\r\n      y.value = data.top\r\n    }\r\n  },\r\n  onResize: (data: ResizeEventCallbackData) => {\r\n    // 性能优化：对于resizemove事件，使用requestAnimationFrame减少响应式更新频率\r\n    if (data.type === 'resizemove') {\r\n      requestAnimationFrame(() => {\r\n        // 更新内部状态\r\n        width.value = data.width\r\n        height.value = data.height\r\n        x.value = data.left\r\n        y.value = data.top\r\n        \r\n        // 发出事件\r\n        emit('resizeMove', data)\r\n      })\r\n    } else {\r\n      // 对于resizestart和resizeend，立即更新\r\n      if (data.type === 'resizestart') {\r\n        isResizing.value = true\r\n        emit('resizeStart', data)\r\n      } else if (data.type === 'resizeend') {\r\n        isResizing.value = false\r\n        emit('resizeEnd', data)\r\n      }\r\n      // 无论哪种类型，都更新位置和尺寸\r\n      width.value = data.width\r\n      height.value = data.height\r\n      x.value = data.left\r\n      y.value = data.top\r\n      activeEdges.value = data.edges || {}\r\n    }\r\n  },\r\n})\r\n\r\n/** 计算选项 - 已使用computed属性缓存计算结果，避免每次渲染都重新创建对象 */\r\nconst computedOptions: ComputedRef<ElementDragResizeOptions> = computed(() => ({\r\n  draggable: props.draggable,\r\n  resizable: props.resizable,\r\n  useCssTransforms: props.useCssTransforms,\r\n  dragOptions: props.dragOptions,\r\n  resizeOptions: props.resizeOptions,\r\n  x: props.initialX,\r\n  y: props.initialY,\r\n  width: props.initialWidth,\r\n  height: props.initialHeight,\r\n}))\r\n\r\n/** 初始化拖拽和调整大小功能 */\r\nconst initializeInteract = (): void => {\r\n  if (!elementRef.value) return\r\n\r\n  // 设置初始数据属性\r\n  elementRef.value.setAttribute('data-x', props.initialX.toString())\r\n  elementRef.value.setAttribute('data-y', props.initialY.toString())\r\n  elementRef.value.setAttribute('data-width', props.initialWidth.toString())\r\n  elementRef.value.setAttribute('data-height', props.initialHeight.toString())\r\n\r\n  // 创建回调函数\r\n  const callbacks = createCallbacks()\r\n\r\n  // 调用 makeElementDraggableResizable\r\n  const result = makeElementDraggableResizable(\r\n    elementRef.value,\r\n    computedOptions.value,\r\n    callbacks,\r\n  )\r\n  cleanupFunction = result.cleanup\r\n  updatePositionAndSizeFunction = result.updatePositionAndSize\r\n  updatePositionFunction = result.updatePosition\r\n  updateSizeFunction = result.updateSize\r\n}\r\n\r\n/** 监听选项变化 - 支持用户配置的deep和immediate选项 */\r\nstopWatchListener.push(\r\n  watch(\r\n    [\r\n      () => props.draggable,\r\n      () => props.resizable,\r\n      () => props.dragOptions,\r\n      () => props.resizeOptions,\r\n    ],\r\n    (): void => {\r\n      if (cleanupFunction) {\r\n        cleanupFunction()\r\n        cleanupFunction = null\r\n      }\r\n      initializeInteract()\r\n    },\r\n    {\r\n      deep: props.watchDeep,\r\n      immediate: props.watchImmediate,\r\n    }),\r\n)\r\n\r\n/** 监听初始位置尺寸变化 - 使用update方法而非重新初始化 */\r\nstopWatchListener.push(\r\n  watch(\r\n    [\r\n      () => props.initialX,\r\n      () => props.initialY,\r\n      () => props.initialWidth,\r\n      () => props.initialHeight,\r\n    ],\r\n    ([newX, newY, newWidth, newHeight]) => {\r\n      if (updatePositionAndSizeFunction) {\r\n        updatePositionAndSizeFunction(newX, newY, newWidth, newHeight)\r\n        if (typeof newX === 'number') x.value = newX\r\n        if (typeof newY === 'number') y.value = newY\r\n        if (typeof newWidth === 'number') width.value = newWidth\r\n        if (typeof newHeight === 'number') height.value = newHeight\r\n      }\r\n    }),\r\n)\r\n\r\n/** 组件挂载时初始化 */\r\nonMounted((): void => {\r\n  initializeInteract()\r\n  // 挂载后如果初始值为字符串单位, 解析为像素更新\r\n  if (typeof props.initialX === 'string') x.value = parsePositionValue(props.initialX, elementRef.value, 'x')\r\n  if (typeof props.initialY === 'string') y.value = parsePositionValue(props.initialY, elementRef.value, 'y')\r\n  if (typeof props.initialWidth === 'string') width.value = parseCssSize(props.initialWidth, elementRef.value, 'width')\r\n  if (typeof props.initialHeight === 'string') height.value = parseCssSize(props.initialHeight, elementRef.value, 'height')\r\n})\r\n\r\n/** 公开方法：更新位置和尺寸 */\r\nconst updatePositionAndSize = throttle((newX: number | string, newY: number | string, newWidth: number | string, newHeight: number | string): void => {\r\n  if (updatePositionAndSizeFunction) {\r\n    updatePositionAndSizeFunction(newX, newY, newWidth, newHeight)\r\n    if (typeof newX === 'number') x.value = newX\r\n    if (typeof newY === 'number') y.value = newY\r\n    if (typeof newWidth === 'number') width.value = newWidth\r\n    if (typeof newHeight === 'number') height.value = newHeight\r\n  }\r\n}, 16)\r\n\r\n/** 公开方法：更新位置 */\r\nconst updatePosition = throttle((newX: number | string, newY: number | string): void => {\r\n  if (updatePositionFunction) {\r\n    updatePositionFunction(newX, newY)\r\n    if (typeof newX === 'number') x.value = newX\r\n    if (typeof newY === 'number') y.value = newY\r\n  }\r\n}, 16)\r\n\r\n/** 公开方法：更新尺寸 */\r\nconst updateSize = throttle((newWidth: number | string, newHeight: number | string): void => {\r\n  if (updateSizeFunction) {\r\n    updateSizeFunction(newWidth, newHeight)\r\n    if (typeof newWidth === 'number') width.value = newWidth\r\n    if (typeof newHeight === 'number') height.value = newHeight\r\n  }\r\n}, 16)\r\n\r\n/** 组件卸载时清理 */\r\nonUnmounted((): void => {\r\n  if (cleanupFunction) {\r\n    cleanupFunction()\r\n    cleanupFunction = null\r\n  }\r\n  if (stopWatchListener?.length) {\r\n    stopWatchListener.forEach((listener) => listener())\r\n    stopWatchListener.length = 0\r\n  }\r\n  updatePositionAndSizeFunction = null\r\n  updatePositionFunction = null\r\n  updateSizeFunction = null\r\n})\r\n\r\n/** 暴露方法给父组件 */\r\ndefineExpose<DraggableResizableWrapperExposed>({\r\n  elementRef,\r\n  x,\r\n  y,\r\n  width,\r\n  height,\r\n  isDragging,\r\n  isResizing,\r\n  activeEdges,\r\n  updatePositionAndSize,\r\n  updatePosition,\r\n  updateSize,\r\n})\r\n</script>\r\n"],"names":["props","__props","emit","__emit","elementRef","ref","x","y","width","height","isDragging","isResizing","activeEdges","cleanupFunction","updatePositionAndSizeFunction","updatePositionFunction","updateSizeFunction","stopWatchListener","slotScope","computed","createCallbacks","data","computedOptions","initializeInteract","callbacks","result","makeElementDraggableResizable","watch","newX","newY","newWidth","newHeight","onMounted","parsePositionValue","parseCssSize","updatePositionAndSize","throttle","updatePosition","updateSize","onUnmounted","listener","__expose"],"mappings":"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"}